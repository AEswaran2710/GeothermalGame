<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geothermal Portfolio Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { margin: 0; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback } = React;

const GeothermalGame = () => {
  const REFERENCE_TEMP = 25;
  const HEAT_CAPACITY = 4.18;
  const HOURS_PER_YEAR = 8000;
  const EXERGY_REFERENCE = 100;
  const BASE_PRICE = 80;
  const DRILLING_FAILURE_RATE = 0.05;
  const MAX_DOUBLETS = 10;
  const COMPETITOR_TAKE_CHANCE = 0.12;
  const SECURE_COST = 2;
  const HOLDING_COST = 0.3;
  const CONSTRUCTION_DELAY = 2;
  
  const SEASONAL_MULTIPLIER = { 0: 1.3, 1: 0.7, 2: 0.6, 3: 1.2 };

  const generateSites = () => {
    const names = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"];
    const colors = ["#e74c3c", "#e67e22", "#f1c40f", "#9b59b6", "#3498db", 
                    "#1abc9c", "#e91e63", "#00bcd4", "#8bc34a", "#ff5722"];
    
    return names.map((name, i) => ({
      id: i, name: `Site ${name}`, color: colors[i],
      trueTemp: Math.floor(80 + Math.random() * 80),
      trueCapacity: 0.5 + Math.random() * 1.5,
      trueDrillingCost: Math.floor(5 + Math.random() * 8),
      trueConstructionCost: Math.floor(3 + Math.random() * 5),
      investigated: 0, revealedTemp: null, revealedDrillingCost: null,
      secured: false, developed: false, takenByCompetitor: false,
      underConstruction: false, constructionCompleteYear: null, plannedFlowRate: null,
    }));
  };

  const createInitialDoublet = () => ({
    id: 0, siteId: -1, siteName: "Legacy", color: "#2ecc71",
    initialTemp: 120, currentTemp: 105, flowRate: 50, thermalCapacity: 1.0,
    yearBuilt: 2020, abandoned: false,
    tempHistory: [
      { year: 2020, temp: 120 }, { year: 2021, temp: 116 }, 
      { year: 2022, temp: 112 }, { year: 2023, temp: 108 }, { year: 2024, temp: 105 }
    ],
    cashHistory: [
      { year: 2020, cash: 2.1 }, { year: 2021, cash: 1.9 }, 
      { year: 2022, cash: 1.7 }, { year: 2023, cash: 1.5 }, { year: 2024, cash: 1.3 }
    ],
    heatHistory: [
      { year: 2020, heat: 160 }, { year: 2021, heat: 152 }, 
      { year: 2022, heat: 144 }, { year: 2023, heat: 136 }, { year: 2024, heat: 128 }
    ],
    currentYearCash: 0, currentYearHeat: 0,
  });

  // Game state
  const [gameStarted, setGameStarted] = useState(false);
  const [year, setYear] = useState(2025);
  const [quarter, setQuarter] = useState(0);
  const [cash, setCash] = useState(15);
  const [sites, setSites] = useState(generateSites());
  const [doublets, setDoublets] = useState([createInitialDoublet()]);
  const [totalHeatDelivered, setTotalHeatDelivered] = useState(0);
  const [gameLog, setGameLog] = useState(["2025 Q1: Game started."]);
  const [selectedSite, setSelectedSite] = useState(null);
  const [developmentFlow, setDevelopmentFlow] = useState(50);
  const [gameOver, setGameOver] = useState(false);
  const [speed, setSpeed] = useState(0);
  const [nextDoubletId, setNextDoubletId] = useState(1);
  const [operatingCostMultiplier, setOperatingCostMultiplier] = useState(1.0);
  const [revenueMultiplier, setRevenueMultiplier] = useState(1.0);
  const [pendingEvent, setPendingEvent] = useState(null);
  const [aggregateCashHistory, setAggregateCashHistory] = useState([
    { year: 2020, cash: 2.1 }, { year: 2021, cash: 1.9 }, 
    { year: 2022, cash: 1.7 }, { year: 2023, cash: 1.5 }, { year: 2024, cash: 1.3 }
  ]);
  const [aggregateHeatHistory, setAggregateHeatHistory] = useState([
    { year: 2020, heat: 160 }, { year: 2021, heat: 152 }, 
    { year: 2022, heat: 144 }, { year: 2023, heat: 136 }, { year: 2024, heat: 128 }
  ]);

  const speedLabels = ["‚è∏ Pause", "‚ñ∂ Play", "‚ñ∂‚ñ∂ Fast", "‚ñ∂‚ñ∂‚ñ∂ Turbo"];
  const speedMultipliers = [0, 1, 2, 5];
  const quarterNames = ["Q1", "Q2", "Q3", "Q4"];

  const getSeasonalMultiplier = useCallback(() => SEASONAL_MULTIPLIER[quarter], [quarter]);
  const getExergyFactor = (temp) => Math.max(0, Math.min(1, (temp - REFERENCE_TEMP) / EXERGY_REFERENCE));
  
  const getHeatOutput = (doublet) => {
    if (doublet.abandoned) return 0;
    const deltaT = doublet.currentTemp - REFERENCE_TEMP;
    if (deltaT <= 5) return 0;
    return (doublet.flowRate * HEAT_CAPACITY * deltaT) / 1000;
  };

  const getQuarterlyRevenue = useCallback((doublet) => {
    if (doublet.abandoned) return 0;
    const heatMW = getHeatOutput(doublet);
    const exergyFactor = getExergyFactor(doublet.currentTemp);
    const pricePerMWh = BASE_PRICE * exergyFactor * revenueMultiplier * getSeasonalMultiplier();
    return (heatMW * (HOURS_PER_YEAR / 4) * pricePerMWh) / 1000000;
  }, [revenueMultiplier, getSeasonalMultiplier]);

  const getQuarterlyOperatingCost = useCallback((doublet) => {
    if (doublet.abandoned) return 0;
    return ((0.3 + (doublet.flowRate * 0.005)) * operatingCostMultiplier) / 4;
  }, [operatingCostMultiplier]);

  const getNewTemperature = (doublet) => {
    if (doublet.abandoned) return doublet.currentTemp;
    const extractionIntensity = doublet.flowRate / 50;
    const declineRate = ((3 + Math.random() * 2) * extractionIntensity / doublet.thermalCapacity) / 4;
    return Math.max(REFERENCE_TEMP + 5, doublet.currentTemp - declineRate);
  };

  const getQuarterlyHeat = (doublet) => {
    if (doublet.abandoned) return 0;
    return getHeatOutput(doublet) * (HOURS_PER_YEAR / 4) / 1000;
  };

  const triggerableEvents = [
    { id: 'backlash', name: "‚ö†Ô∏è Public Backlash", description: "Environmental groups organizing against geothermal.",
      choices: [
        { text: "Launch PR Campaign (‚Ç¨2M)", cost: 2, effect: () => {} },
        { text: "Accept -20% revenue for 3 years", cost: 0, effect: () => setRevenueMultiplier(0.8) },
      ], probability: 0.02 },
    { id: 'cost_surge', name: "‚ö†Ô∏è Supply Chain Crisis", description: "Equipment and materials prices spiking.",
      choices: [
        { text: "Stockpile materials (‚Ç¨3M)", cost: 3, effect: () => {} },
        { text: "Accept +30% operating costs", cost: 0, effect: () => setOperatingCostMultiplier(m => m * 1.3) },
      ], probability: 0.025 },
    { id: 'subsidy', name: "üí∞ Government Grant Available", description: "Green energy subsidy program announced.",
      choices: [
        { text: "Accept ‚Ç¨5M grant", cost: 0, effect: () => setCash(c => c + 5) },
        { text: "Skip (no strings attached)", cost: 0, effect: () => {} },
      ], probability: 0.015 },
  ];

  const checkForEvents = useCallback(() => {
    if (pendingEvent) return;
    for (const event of triggerableEvents) {
      if (Math.random() < event.probability) {
        setPendingEvent(event);
        setSpeed(0);
        break;
      }
    }
  }, [pendingEvent]);

  const handleEventChoice = (choiceIndex) => {
    const choice = pendingEvent.choices[choiceIndex];
    if (cash >= choice.cost) {
      setCash(c => c - choice.cost);
      choice.effect();
      addLog(`${pendingEvent.name} ‚Üí ${choice.text}`);
    }
    setPendingEvent(null);
  };

  const investigationCosts = { 1: 0.5, 2: 1.5, 3: 4.0 };

  const investigateSite = (siteId, level) => {
    const site = sites[siteId];
    if (site.investigated >= level || site.takenByCompetitor || cash < investigationCosts[level]) return;

    const newSites = [...sites];
    newSites[siteId] = { ...site, investigated: level };
    
    const variance = 20 - (level * 5);
    newSites[siteId].revealedTemp = level >= 3 
      ? { min: site.trueTemp, max: site.trueTemp }
      : { min: Math.max(60, site.trueTemp - variance), max: Math.min(180, site.trueTemp + variance) };
    
    if (level >= 2) {
      const cv = 3 - level;
      newSites[siteId].revealedDrillingCost = level >= 3
        ? { min: site.trueDrillingCost, max: site.trueDrillingCost }
        : { min: Math.max(3, site.trueDrillingCost - cv), max: site.trueDrillingCost + cv };
    }

    setSites(newSites);
    setCash(c => c - investigationCosts[level]);
    addLog(`Investigated ${site.name} (Level ${level})`);
  };

  const secureSite = (siteId) => {
    const site = sites[siteId];
    if (site.secured || site.takenByCompetitor || site.developed || cash < SECURE_COST) return;
    const newSites = [...sites];
    newSites[siteId] = { ...site, secured: true };
    setSites(newSites);
    setCash(c => c - SECURE_COST);
    addLog(`Secured ${site.name}`);
  };

  const startDevelopment = (siteId, flowRate) => {
    const site = sites[siteId];
    if (!site.secured || site.developed || site.underConstruction) return;
    const activeCount = doublets.filter(d => !d.abandoned).length + sites.filter(s => s.underConstruction).length;
    if (activeCount >= MAX_DOUBLETS || cash < site.trueDrillingCost) return;

    if (Math.random() < DRILLING_FAILURE_RATE) {
      setCash(c => c - site.trueDrillingCost);
      addLog(`‚ùå DRILLING FAILED at ${site.name}! ‚Ç¨${site.trueDrillingCost}M lost!`);
      const newSites = [...sites];
      newSites[siteId] = { ...site, developed: true, secured: false };
      setSites(newSites);
      return;
    }

    const newSites = [...sites];
    newSites[siteId] = { ...site, underConstruction: true, constructionCompleteYear: year + CONSTRUCTION_DELAY, plannedFlowRate: flowRate };
    setSites(newSites);
    setCash(c => c - site.trueDrillingCost);
    addLog(`Started drilling ${site.name} ‚Üí Ready ${year + CONSTRUCTION_DELAY}`);
  };

  const checkConstructionComplete = useCallback(() => {
    let changed = false;
    const newSites = [...sites];
    let newDoublets = [...doublets];

    sites.forEach((site, i) => {
      if (site.underConstruction && site.constructionCompleteYear <= year && cash >= site.trueConstructionCost) {
        setCash(c => c - site.trueConstructionCost);
        newDoublets.push({
          id: nextDoubletId, siteId: site.id, siteName: site.name, color: site.color,
          initialTemp: site.trueTemp, currentTemp: site.trueTemp,
          flowRate: site.plannedFlowRate, thermalCapacity: site.trueCapacity,
          yearBuilt: year, abandoned: false,
          tempHistory: [{ year, temp: site.trueTemp }],
          cashHistory: [], heatHistory: [],
          currentYearCash: 0, currentYearHeat: 0,
        });
        setNextDoubletId(id => id + 1);
        newSites[i] = { ...site, underConstruction: false, developed: true, secured: false };
        changed = true;
        addLog(`‚úì ${site.name} is now operational!`);
      }
    });

    if (changed) { setSites(newSites); setDoublets(newDoublets); }
  }, [sites, doublets, year, cash, nextDoubletId]);

  const competitorAction = useCallback(() => {
    const newSites = [...sites];
    let changed = false;
    sites.forEach((site, i) => {
      if (!site.secured && !site.developed && !site.takenByCompetitor && !site.underConstruction) {
        if (Math.random() < COMPETITOR_TAKE_CHANCE / 4) {
          newSites[i] = { ...site, takenByCompetitor: true };
          changed = true;
          addLog(`Competitor has taken ${site.name}!`);
        }
      }
    });
    if (changed) setSites(newSites);
  }, [sites]);

  const abandonDoublet = (id) => {
    setDoublets(ds => ds.map(d => d.id === id ? { ...d, abandoned: true } : d));
    addLog(`Abandoned ${doublets.find(d => d.id === id)?.siteName}`);
  };

  const advanceQuarter = useCallback(() => {
    if (gameOver || pendingEvent || !gameStarted) return;
    checkForEvents();
    if (pendingEvent) return;
    competitorAction();

    let quarterlyNetCash = 0;

    const newDoublets = doublets.map(d => {
      if (d.abandoned) return d;
      
      const heat = getQuarterlyHeat(d);
      const revenue = getQuarterlyRevenue(d);
      const cost = getQuarterlyOperatingCost(d);
      const newTemp = getNewTemperature(d);
      const netCash = revenue - cost;
      
      quarterlyNetCash += netCash;

      return {
        ...d, currentTemp: newTemp,
        currentYearCash: (d.currentYearCash || 0) + netCash,
        currentYearHeat: (d.currentYearHeat || 0) + heat,
      };
    });

    const holdingCosts = sites.filter(s => s.secured && !s.developed && !s.underConstruction).length * (HOLDING_COST / 4);
    quarterlyNetCash -= holdingCosts;

    const newCash = cash + quarterlyNetCash;
    const quarterlyHeat = newDoublets.reduce((sum, d) => sum + (d.abandoned ? 0 : getQuarterlyHeat(d)), 0);
    
    setDoublets(newDoublets);
    setCash(newCash);
    setTotalHeatDelivered(t => t + quarterlyHeat);

    if (quarter === 3) {
      const totalYearCash = newDoublets.reduce((sum, d) => sum + (d.currentYearCash || 0), 0) - (holdingCosts * 4);
      const totalYearHeat = newDoublets.reduce((sum, d) => sum + (d.currentYearHeat || 0), 0);
      
      setAggregateCashHistory(h => [...h, { year, cash: totalYearCash }].slice(-15));
      setAggregateHeatHistory(h => [...h, { year, heat: totalYearHeat }].slice(-15));
      
      const updatedDoublets = newDoublets.map(d => {
        if (d.abandoned) return d;
        return {
          ...d,
          tempHistory: [...d.tempHistory, { year, temp: d.currentTemp }].slice(-15),
          cashHistory: [...d.cashHistory, { year, cash: d.currentYearCash || 0 }].slice(-15),
          heatHistory: [...d.heatHistory, { year, heat: d.currentYearHeat || 0 }].slice(-15),
          currentYearCash: 0, currentYearHeat: 0,
        };
      });
      
      setDoublets(updatedDoublets);
      setYear(y => y + 1);
      setQuarter(0);
      setTimeout(() => checkConstructionComplete(), 0);
    } else {
      setQuarter(q => q + 1);
    }

    if (newCash < -10) { setGameOver(true); setSpeed(0); addLog("GAME OVER: Bankruptcy!"); }
    
    const active = newDoublets.filter(d => !d.abandoned && getHeatOutput(d) > 0);
    const available = sites.filter(s => !s.developed && !s.takenByCompetitor);
    if (active.length === 0 && available.length === 0) { setGameOver(true); setSpeed(0); addLog("GAME OVER: All resources exhausted!"); }
  }, [gameOver, pendingEvent, gameStarted, doublets, cash, quarter, year, sites, checkForEvents, competitorAction, getQuarterlyRevenue, getQuarterlyOperatingCost, checkConstructionComplete]);

  useEffect(() => {
    if (speed === 0 || gameOver || pendingEvent || !gameStarted) return;
    const interval = setInterval(advanceQuarter, 800 / speedMultipliers[speed]);
    return () => clearInterval(interval);
  }, [speed, gameOver, pendingEvent, gameStarted, advanceQuarter]);

  useEffect(() => {
    if (quarter === 0 && year > 2025) checkConstructionComplete();
  }, [year, quarter, checkConstructionComplete]);

  const addLog = (msg) => setGameLog(log => [...log.slice(-9), `${year} ${quarterNames[quarter]}: ${msg}`]);

  const resetGame = () => {
    setYear(2025); setQuarter(0); setCash(15);
    setSites(generateSites()); setDoublets([createInitialDoublet()]);
    setTotalHeatDelivered(0); setGameLog(["2025 Q1: Game started."]);
    setSelectedSite(null); setGameOver(false); setSpeed(0);
    setNextDoubletId(1); setOperatingCostMultiplier(1.0); setRevenueMultiplier(1.0);
    setPendingEvent(null); setGameStarted(false);
    setAggregateCashHistory([
      { year: 2020, cash: 2.1 }, { year: 2021, cash: 1.9 }, { year: 2022, cash: 1.7 }, { year: 2023, cash: 1.5 }, { year: 2024, cash: 1.3 }
    ]);
    setAggregateHeatHistory([
      { year: 2020, heat: 160 }, { year: 2021, heat: 152 }, { year: 2022, heat: 144 }, { year: 2023, heat: 136 }, { year: 2024, heat: 128 }
    ]);
  };

  // Sparkline component
  const Sparkline = ({ data, dataKey, color, height = 35, showZero = false }) => {
    if (!data || data.length < 2) return <div className="text-gray-600 text-xs italic">No data yet</div>;
    
    const values = data.map(d => d[dataKey]);
    const minVal = showZero ? Math.min(0, ...values) : Math.min(...values);
    const maxVal = Math.max(...values);
    const range = maxVal - minVal || 1;

    return (
      <svg width="100%" height={height} viewBox={`0 0 100 ${height}`} preserveAspectRatio="none">
        {showZero && (
          <line x1="0" y1={height - ((0 - minVal) / range) * height} 
                x2="100" y2={height - ((0 - minVal) / range) * height} 
                stroke="#555" strokeWidth="0.5" />
        )}
        <polyline fill="none" stroke={color} strokeWidth="2"
          points={data.map((d, i) => {
            const x = (i / (data.length - 1)) * 100;
            const y = height - ((d[dataKey] - minVal) / range) * height;
            return `${x},${y}`;
          }).join(' ')} />
      </svg>
    );
  };

  const TempBar = ({ temp }) => {
    const pct = Math.max(0, ((temp - REFERENCE_TEMP) / (160 - REFERENCE_TEMP)) * 100);
    return (
      <div className="w-full h-3 bg-gray-700 rounded overflow-hidden">
        <div className="h-full transition-all" style={{ width: `${pct}%`, backgroundColor: `hsl(${Math.min(60, pct * 0.6)}, 80%, 50%)` }} />
      </div>
    );
  };

  const seasonEmoji = ['‚ùÑÔ∏è', 'üå∏', '‚òÄÔ∏è', 'üçÇ'][quarter];
  const seasonName = ['Winter', 'Spring', 'Summer', 'Autumn'][quarter];

  // Instructions Overlay Component
  const InstructionsOverlay = () => (
    <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-800 rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
        {/* Header */}
        <div className="bg-gradient-to-r from-orange-600 to-red-600 p-6 rounded-t-xl">
          <h1 className="text-3xl font-bold text-white">üåã Geothermal Portfolio Manager</h1>
          <p className="text-orange-100 mt-2">A strategy game about deep geothermal energy exploitation</p>
        </div>

        <div className="p-6 space-y-6">
          {/* Objective */}
          <div className="bg-gray-900 p-4 rounded-lg">
            <h2 className="text-xl font-bold text-yellow-400 mb-2">üéØ Objective</h2>
            <p className="text-gray-300">
              Manage a portfolio of geothermal doublets to deliver heat while maintaining profitability. 
              Balance exploration, development, and operations while competing for limited sites.
            </p>
          </div>

          {/* Game Setup */}
          <div className="bg-gray-900 p-4 rounded-lg">
            <h2 className="text-xl font-bold text-green-400 mb-3">üìã Starting Conditions</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div className="flex items-center gap-2">
                <span className="text-2xl">üí∞</span>
                <div>
                  <div className="font-medium text-white">‚Ç¨15M Starting Capital</div>
                  <div className="text-gray-400">Bankruptcy at -‚Ç¨10M</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-2xl">üè≠</span>
                <div>
                  <div className="font-medium text-white">1 Legacy Doublet</div>
                  <div className="text-gray-400">Already declining (105¬∞C)</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-2xl">üó∫Ô∏è</span>
                <div>
                  <div className="font-medium text-white">10 Potential Sites</div>
                  <div className="text-gray-400">Unknown properties until investigated</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-2xl">üè¢</span>
                <div>
                  <div className="font-medium text-white">Competitors Active</div>
                  <div className="text-gray-400">Will take unsecured sites</div>
                </div>
              </div>
            </div>
          </div>

          {/* Controls */}
          <div className="bg-gray-900 p-4 rounded-lg">
            <h2 className="text-xl font-bold text-blue-400 mb-3">üéÆ Controls</h2>
            <div className="space-y-3 text-sm">
              <div className="flex items-start gap-3">
                <div className="bg-gray-700 px-3 py-1 rounded font-mono text-xs whitespace-nowrap">‚è∏ ‚ñ∂ ‚ñ∂‚ñ∂ ‚ñ∂‚ñ∂‚ñ∂</div>
                <div>
                  <div className="font-medium text-white">Speed Controls</div>
                  <div className="text-gray-400">Pause, Play, Fast, Turbo - time advances by quarter</div>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <div className="bg-blue-600 px-3 py-1 rounded text-xs whitespace-nowrap">Site Card</div>
                <div>
                  <div className="font-medium text-white">Click to Select Site</div>
                  <div className="text-gray-400">Opens action panel for investigation/securing/development</div>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <div className="bg-red-600 px-3 py-1 rounded text-xs whitespace-nowrap">Abandon</div>
                <div>
                  <div className="font-medium text-white">Stop Operating a Doublet</div>
                  <div className="text-gray-400">Use when temperature drops too low to be profitable</div>
                </div>
              </div>
            </div>
          </div>

          {/* Development Pipeline */}
          <div className="bg-gray-900 p-4 rounded-lg">
            <h2 className="text-xl font-bold text-purple-400 mb-3">‚öôÔ∏è Development Pipeline</h2>
            <div className="flex items-center gap-2 text-sm overflow-x-auto pb-2">
              <div className="bg-gray-700 p-2 rounded text-center min-w-24">
                <div className="text-blue-400 font-medium">Investigate</div>
                <div className="text-xs text-gray-400">‚Ç¨0.5-4M</div>
                <div className="text-xs text-gray-500">Reveals properties</div>
              </div>
              <span className="text-gray-500">‚Üí</span>
              <div className="bg-gray-700 p-2 rounded text-center min-w-24">
                <div className="text-purple-400 font-medium">Secure</div>
                <div className="text-xs text-gray-400">‚Ç¨2M + ‚Ç¨0.3M/yr</div>
                <div className="text-xs text-gray-500">Blocks competitors</div>
              </div>
              <span className="text-gray-500">‚Üí</span>
              <div className="bg-gray-700 p-2 rounded text-center min-w-24">
                <div className="text-green-400 font-medium">Drill</div>
                <div className="text-xs text-gray-400">‚Ç¨5-13M</div>
                <div className="text-xs text-gray-500">5% failure risk</div>
              </div>
              <span className="text-gray-500">‚Üí</span>
              <div className="bg-gray-700 p-2 rounded text-center min-w-24">
                <div className="text-yellow-400 font-medium">Build</div>
                <div className="text-xs text-gray-400">2 years</div>
                <div className="text-xs text-gray-500">Then operational</div>
              </div>
            </div>
          </div>

          {/* Economics */}
          <div className="bg-gray-900 p-4 rounded-lg">
            <h2 className="text-xl font-bold text-orange-400 mb-3">üìä Economics</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <div className="font-medium text-white mb-1">Exergy Pricing</div>
                <div className="text-gray-400">Higher temperature = higher price per MWh</div>
                <div className="text-gray-500 text-xs">Base ‚Ç¨80/MWh at ŒîT=100¬∞C</div>
              </div>
              <div>
                <div className="font-medium text-white mb-1">Seasonal Demand</div>
                <div className="text-gray-400">Winter +30%, Summer -40%</div>
                <div className="text-gray-500 text-xs">Plan cash flow accordingly</div>
              </div>
              <div>
                <div className="font-medium text-white mb-1">Temperature Decline</div>
                <div className="text-gray-400">Reservoirs cool over time</div>
                <div className="text-gray-500 text-xs">Higher flow = faster decline</div>
              </div>
              <div>
                <div className="font-medium text-white mb-1">Random Events</div>
                <div className="text-gray-400">Public backlash, subsidies, crises</div>
                <div className="text-gray-500 text-xs">Require strategic decisions</div>
              </div>
            </div>
          </div>

          {/* Tips */}
          <div className="bg-blue-900/30 border border-blue-500/50 p-4 rounded-lg">
            <h2 className="text-lg font-bold text-blue-300 mb-2">üí° Tips for Success</h2>
            <ul className="text-sm text-gray-300 space-y-1 list-disc list-inside">
              <li>Investigate sites before committing large capital to drilling</li>
              <li>Secure promising sites early - competitors are always watching</li>
              <li>Balance flow rate: higher output but faster temperature decline</li>
              <li>Have new doublets coming online before old ones become unprofitable</li>
              <li>Keep cash reserves for random events and opportunities</li>
            </ul>
          </div>

          {/* Start Button */}
          <button 
            onClick={() => setGameStarted(true)}
            className="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 rounded-lg text-xl font-bold text-white transition-all transform hover:scale-105 shadow-lg"
          >
            üöÄ Start Game
          </button>
        </div>
      </div>
    </div>
  );

  // Main game render
  return (
    <div className="min-h-screen bg-gray-900 text-white p-4">
      {/* Instructions Overlay */}
      {!gameStarted && <InstructionsOverlay />}

      <div className="max-w-7xl mx-auto">
        
        {/* Header */}
        <div className="flex justify-between items-center mb-4 p-4 bg-gray-800 rounded-lg">
          <div>
            <h1 className="text-2xl font-bold">üåã Geothermal Portfolio Manager</h1>
            <p className="text-gray-400 text-sm">Deep geothermal exploitation with exergy pricing</p>
          </div>
          <div className="flex items-center gap-6">
            <div className="flex gap-1">
              {speedLabels.map((label, i) => (
                <button key={i} onClick={() => setSpeed(i)} disabled={!!pendingEvent}
                  className={`px-4 py-2 rounded font-medium transition-all ${speed === i ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`}>
                  {label}
                </button>
              ))}
            </div>
            <div className="text-right min-w-40 bg-gray-900 p-3 rounded-lg">
              <div className="text-2xl font-mono">{seasonEmoji} {year} {quarterNames[quarter]}</div>
              <div className={`text-xl font-bold ${cash >= 0 ? 'text-green-400' : 'text-red-400'}`}>‚Ç¨{cash.toFixed(1)}M</div>
              <div className="text-xs text-gray-400">{seasonName} ({SEASONAL_MULTIPLIER[quarter] > 1 ? '+' : ''}{((SEASONAL_MULTIPLIER[quarter] - 1) * 100).toFixed(0)}% demand)</div>
            </div>
          </div>
        </div>

        {/* Event Modal */}
        {pendingEvent && (
          <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
            <div className="bg-gray-800 p-6 rounded-lg max-w-md border-2 border-yellow-500 shadow-xl">
              <h2 className="text-xl font-bold mb-2">{pendingEvent.name}</h2>
              <p className="text-gray-300 mb-4">{pendingEvent.description}</p>
              <div className="space-y-2">
                {pendingEvent.choices.map((choice, i) => (
                  <button key={i} onClick={() => handleEventChoice(i)} disabled={cash < choice.cost}
                    className={`w-full p-3 rounded text-left font-medium ${cash >= choice.cost ? 'bg-gray-700 hover:bg-gray-600 border border-gray-600' : 'opacity-50 bg-gray-800'}`}>
                    {choice.text}
                    {choice.cost > 0 && cash < choice.cost && <span className="text-red-400 text-xs ml-2">(insufficient funds)</span>}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Main Content Grid */}
        <div className="grid grid-cols-3 gap-4 mb-4">
          
          {/* Sites Panel - Left Column */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <h2 className="text-lg font-bold mb-3 pb-2 border-b border-gray-700">
              üó∫Ô∏è Available Sites ({sites.filter(s => !s.developed && !s.takenByCompetitor).length}/10)
            </h2>
            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
              {sites.map((site, i) => (
                <div key={i}
                  className={`p-3 rounded-lg cursor-pointer transition-all ${
                    site.takenByCompetitor ? 'bg-red-900/30 border border-red-800' :
                    site.developed ? 'bg-gray-700/50 opacity-60' :
                    site.underConstruction ? 'bg-yellow-900/30 border border-yellow-700' :
                    selectedSite === i ? 'bg-blue-900 border-2 border-blue-500' : 'bg-gray-700 hover:bg-gray-650 border border-transparent hover:border-gray-600'
                  }`}
                  style={{ borderLeftWidth: '5px', borderLeftColor: site.color }}
                  onClick={() => !site.developed && !site.takenByCompetitor && setSelectedSite(selectedSite === i ? null : i)}>
                  <div className="flex justify-between items-center">
                    <span className="font-bold text-lg">{site.name}</span>
                    <div className="flex gap-1">
                      {site.secured && !site.developed && !site.underConstruction && <span className="bg-blue-600 text-xs px-2 py-0.5 rounded">üîí Secured</span>}
                      {site.underConstruction && <span className="bg-yellow-600 text-xs px-2 py-0.5 rounded">üèóÔ∏è Building</span>}
                      {site.developed && <span className="bg-green-600 text-xs px-2 py-0.5 rounded">‚úì Active</span>}
                    </div>
                  </div>
                  {site.takenByCompetitor && (
                    <div className="text-red-400 text-sm mt-1 font-medium">Competitor has taken this site</div>
                  )}
                  {site.investigated > 0 && !site.developed && !site.takenByCompetitor && (
                    <div className="text-gray-300 text-sm mt-2 bg-gray-800 p-2 rounded">
                      <div className="flex justify-between">
                        <span>Temperature:</span>
                        <span className="font-mono">
                          {site.revealedTemp?.min === site.revealedTemp?.max 
                            ? `${site.revealedTemp?.min}¬∞C` 
                            : `${site.revealedTemp?.min}-${site.revealedTemp?.max}¬∞C`}
                        </span>
                      </div>
                      {site.revealedDrillingCost && (
                        <div className="flex justify-between">
                          <span>Drilling cost:</span>
                          <span className="font-mono">‚Ç¨{site.revealedDrillingCost.min === site.revealedDrillingCost.max ? site.revealedDrillingCost.min : `${site.revealedDrillingCost.min}-${site.revealedDrillingCost.max}`}M</span>
                        </div>
                      )}
                      <div className="text-xs text-gray-500 mt-1">Investigation level: {site.investigated}/3</div>
                    </div>
                  )}
                  {site.underConstruction && (
                    <div className="text-yellow-400 text-sm mt-1">Ready in {site.constructionCompleteYear}</div>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* Actions Panel - Middle Column */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <h2 className="text-lg font-bold mb-3 pb-2 border-b border-gray-700">‚öôÔ∏è Actions</h2>
            {selectedSite !== null && !sites[selectedSite].developed && !sites[selectedSite].takenByCompetitor && !sites[selectedSite].underConstruction ? (
              <div>
                <div className="text-2xl font-bold mb-4 flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{ backgroundColor: sites[selectedSite].color }}></div>
                  {sites[selectedSite].name}
                </div>
                
                <div className="space-y-4">
                  {/* Investigation */}
                  <div className="bg-gray-900 p-4 rounded-lg">
                    <div className="text-sm text-gray-400 mb-2 font-medium">üîç Investigation (Level {sites[selectedSite].investigated}/3)</div>
                    <div className="space-y-2">
                      {sites[selectedSite].investigated < 1 && (
                        <button onClick={() => investigateSite(selectedSite, 1)} disabled={cash < 0.5}
                          className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:opacity-50 px-4 py-3 rounded-lg font-medium transition-all">
                          Basic Survey - ‚Ç¨0.5M
                          <div className="text-xs text-blue-200 mt-1">Reveals temperature range (¬±15¬∞C)</div>
                        </button>
                      )}
                      {sites[selectedSite].investigated >= 1 && sites[selectedSite].investigated < 2 && (
                        <button onClick={() => investigateSite(selectedSite, 2)} disabled={cash < 1.5}
                          className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:opacity-50 px-4 py-3 rounded-lg font-medium transition-all">
                          Detailed Survey - ‚Ç¨1.5M
                          <div className="text-xs text-blue-200 mt-1">Better temperature estimate + drilling cost range</div>
                        </button>
                      )}
                      {sites[selectedSite].investigated >= 2 && sites[selectedSite].investigated < 3 && (
                        <button onClick={() => investigateSite(selectedSite, 3)} disabled={cash < 4}
                          className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:opacity-50 px-4 py-3 rounded-lg font-medium transition-all">
                          Test Drilling - ‚Ç¨4M
                          <div className="text-xs text-blue-200 mt-1">Reveals exact temperature and drilling cost</div>
                        </button>
                      )}
                      {sites[selectedSite].investigated >= 3 && (
                        <div className="text-green-400 text-center py-2 font-medium">‚úì Fully investigated</div>
                      )}
                    </div>
                  </div>

                  {/* Securing */}
                  {!sites[selectedSite].secured && (
                    <div className="bg-gray-900 p-4 rounded-lg">
                      <div className="text-sm text-gray-400 mb-2 font-medium">üîí Secure from Competitors</div>
                      <button onClick={() => secureSite(selectedSite)} disabled={cash < SECURE_COST}
                        className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:opacity-50 px-4 py-3 rounded-lg font-medium transition-all">
                        Secure Site - ‚Ç¨{SECURE_COST}M
                        <div className="text-xs text-purple-200 mt-1">‚Ç¨{HOLDING_COST}M/year holding cost while secured</div>
                      </button>
                    </div>
                  )}

                  {/* Development */}
                  {sites[selectedSite].secured && sites[selectedSite].investigated > 0 && (
                    <div className="bg-gray-900 p-4 rounded-lg">
                      <div className="text-sm text-gray-400 mb-2 font-medium">üèóÔ∏è Development</div>
                      <div className="mb-3">
                        <div className="flex justify-between text-sm mb-1">
                          <span>Flow rate:</span>
                          <span className="font-mono font-bold">{developmentFlow} kg/s</span>
                        </div>
                        <input type="range" min="20" max="100" value={developmentFlow}
                          onChange={(e) => setDevelopmentFlow(parseInt(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          <span>Low output, slow decline</span>
                          <span>High output, fast decline</span>
                        </div>
                      </div>
                      <button onClick={() => startDevelopment(selectedSite, developmentFlow)}
                        disabled={cash < sites[selectedSite].trueDrillingCost || doublets.filter(d => !d.abandoned).length + sites.filter(s => s.underConstruction).length >= MAX_DOUBLETS}
                        className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:opacity-50 px-4 py-3 rounded-lg font-medium transition-all">
                        Start Drilling - ‚Ç¨{sites[selectedSite].trueDrillingCost}M
                        <div className="text-xs text-green-200 mt-1">5% failure risk ‚Ä¢ {CONSTRUCTION_DELAY} years to completion</div>
                      </button>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="text-gray-500 italic text-center py-12">
                <div className="text-4xl mb-3">üëà</div>
                <div>Select an available site to see actions</div>
              </div>
            )}
          </div>

          {/* Log Panel - Right Column */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <h2 className="text-lg font-bold mb-3 pb-2 border-b border-gray-700">üìú Event Log</h2>
            <div className="text-sm text-gray-300 space-y-1 h-96 overflow-y-auto font-mono bg-gray-900 p-3 rounded-lg">
              {gameLog.map((e, i) => (
                <div key={i} className="py-1 border-b border-gray-800 last:border-0">{e}</div>
              ))}
            </div>
          </div>
        </div>

        {/* Active Doublets */}
        <div className="bg-gray-800 p-4 rounded-lg mb-4">
          <h2 className="text-lg font-bold mb-3 pb-2 border-b border-gray-700">
            üè≠ Active Doublets ({doublets.filter(d => !d.abandoned).length}/{MAX_DOUBLETS} max)
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {doublets.map(d => (
              <div key={d.id} 
                className={`p-4 rounded-lg ${d.abandoned ? 'opacity-40 bg-gray-900' : 'bg-gray-900'}`}
                style={{ borderLeft: `5px solid ${d.color}` }}>
                
                {/* Header */}
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <div className="font-bold text-xl" style={{ color: d.color }}>{d.siteName}</div>
                    <div className="text-gray-400 text-sm">Since {d.yearBuilt} ‚Ä¢ {d.flowRate} kg/s</div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-mono font-bold">{d.currentTemp.toFixed(0)}¬∞C</div>
                    <div className="text-sm text-gray-400">{getHeatOutput(d).toFixed(1)} MW thermal</div>
                  </div>
                </div>
                
                <TempBar temp={d.currentTemp} />
                
                {d.abandoned && <div className="text-red-400 text-center mt-3 font-bold text-lg">ABANDONED</div>}
                
                {!d.abandoned && (
                  <>
                    <div className="grid grid-cols-3 gap-3 mt-4">
                      <div className="bg-gray-800 p-2 rounded">
                        <div className="text-xs text-gray-500 mb-1">Temperature History</div>
                        <Sparkline data={d.tempHistory} dataKey="temp" color={d.color} height={50} />
                        <div className="text-xs text-gray-400 text-right mt-1">{d.tempHistory[d.tempHistory.length-1]?.temp.toFixed(0)}¬∞C</div>
                      </div>
                      <div className="bg-gray-800 p-2 rounded">
                        <div className="text-xs text-gray-500 mb-1">Annual Cash Flow</div>
                        <Sparkline data={d.cashHistory} dataKey="cash" color="#10b981" height={50} showZero />
                        <div className="text-xs text-gray-400 text-right mt-1">‚Ç¨{d.cashHistory[d.cashHistory.length-1]?.cash.toFixed(1) || '0'}M</div>
                      </div>
                      <div className="bg-gray-800 p-2 rounded">
                        <div className="text-xs text-gray-500 mb-1">Annual Heat Delivered</div>
                        <Sparkline data={d.heatHistory} dataKey="heat" color="#f59e0b" height={50} />
                        <div className="text-xs text-gray-400 text-right mt-1">{d.heatHistory[d.heatHistory.length-1]?.heat.toFixed(0) || '0'} GWh</div>
                      </div>
                    </div>
                    <button onClick={() => abandonDoublet(d.id)} 
                      className="mt-3 w-full text-red-400 hover:text-red-300 text-sm py-2 rounded hover:bg-red-900/30 border border-red-900 transition-all">
                      Abandon Doublet
                    </button>
                  </>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Portfolio Summary */}
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div className="bg-gray-800 p-4 rounded-lg">
            <h3 className="text-lg font-bold mb-3">üìà Portfolio Annual Cash Flow</h3>
            <Sparkline data={aggregateCashHistory} dataKey="cash" color="#3b82f6" height={80} showZero />
            <div className="flex justify-between text-sm text-gray-400 mt-2">
              <span>{aggregateCashHistory[0]?.year}</span>
              <span className="font-bold text-blue-400 text-lg">‚Ç¨{aggregateCashHistory[aggregateCashHistory.length-1]?.cash.toFixed(1)}M/year</span>
              <span>{aggregateCashHistory[aggregateCashHistory.length-1]?.year}</span>
            </div>
          </div>

          <div className="bg-gray-800 p-4 rounded-lg">
            <h3 className="text-lg font-bold mb-3">üî• Portfolio Annual Heat Delivered</h3>
            <Sparkline data={aggregateHeatHistory} dataKey="heat" color="#f59e0b" height={80} />
            <div className="flex justify-between text-sm text-gray-400 mt-2">
              <span>{aggregateHeatHistory[0]?.year}</span>
              <span className="font-bold text-amber-400 text-lg">{aggregateHeatHistory[aggregateHeatHistory.length-1]?.heat.toFixed(0)} GWh/year</span>
              <span>{aggregateHeatHistory[aggregateHeatHistory.length-1]?.year}</span>
            </div>
            <div className="text-center text-sm text-gray-500 mt-2 pt-2 border-t border-gray-700">
              Total delivered since 2020: <span className="font-bold text-white">{totalHeatDelivered.toFixed(0)} GWh</span>
            </div>
          </div>
        </div>

        {/* Game Over */}
        {gameOver && (
          <div className="p-6 bg-red-900 rounded-lg text-center">
            <div className="text-3xl font-bold mb-2">GAME OVER</div>
            <div className="text-xl">Total Heat Delivered: {totalHeatDelivered.toFixed(0)} GWh over {year - 2025} years</div>
            <button onClick={resetGame} className="mt-4 bg-gray-600 hover:bg-gray-500 px-8 py-3 rounded-lg font-bold text-lg">
              Play Again
            </button>
          </div>
        )}

        {/* Footer */}
        <div className="p-3 bg-gray-800 rounded-lg text-sm text-gray-500 flex justify-between items-center">
          <div>
            <strong>Exergy pricing:</strong> ‚Ç¨{BASE_PRICE}/MWh at ŒîT={EXERGY_REFERENCE}¬∞C ‚Ä¢ 
            <strong> Secure:</strong> ‚Ç¨{SECURE_COST}M + ‚Ç¨{HOLDING_COST}M/yr ‚Ä¢ 
            <strong> Build time:</strong> {CONSTRUCTION_DELAY} years ‚Ä¢ 
            <strong> Drill failure:</strong> {DRILLING_FAILURE_RATE * 100}%
          </div>
          <div className="flex gap-2">
            <button onClick={() => setGameStarted(false)} className="text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-gray-700">
              üìñ Instructions
            </button>
            <button onClick={resetGame} className="text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-gray-700">
              üîÑ Reset Game
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};



ReactDOM.render(<GeothermalGame />, document.getElementById('root'));
    </script>
</body>
</html>
